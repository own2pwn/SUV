#!/usr/bin/env bash

root_dir=$(pwd)
core_dir="$root_dir/build/SwiftestCore"
client_dir="$root_dir/build/SwiftestClient"
src_dir="$root_dir/build/SUV"
uv_dir="$root_dir/lib/libUV"
includes="-L$core_dir -I$core_dir -L$client_dir -I$client_dir -L$src_dir -I$src_dir -I$uv_dir -I/usr/include"
dyld_path="$core_dir:$client_dir:$src_dir"

if [ $# -eq 0 ]; then
  files=$(find ./spec -type f -name "*[Ss]pec.swift")
else
  files=$(find $@)
fi
tempfile="/tmp/swiftest-specs-$(date +%s).swift"

cat $files > $tempfile
echo "SwiftestClient.run()" >> $tempfile

DYLD_LIBRARY_PATH="$dyld_path" swiftc $includes -lSwiftestCore -lSwiftestClient -lSUV $tempfile -o build/tests
DYLD_LIBRARY_PATH=$dyld_path build/tests

rm $tempfile
